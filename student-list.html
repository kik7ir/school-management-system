<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student List - School Management System</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SheetJS library for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx/0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Full Screen Layout */
        :root {
            --primary-dark: #0a192f;
            --primary-blue: #172a45;
            --accent-blue: #64ffda;
            --text-light: #e6f1ff;
            --text-muted: #8892b0;
            --border-color: #233554;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-dark);
            color: var(--text-light);
            line-height: 1.6;
        }

        /* Header Styles */
        header {
            background-color: var(--primary-blue);
            color: var(--text-light);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-color);
        }

        .header-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Main Content */
        main {
            height: calc(100vh - 80px);
            padding: 1.5rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--primary-blue);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        .search-box {
            position: relative;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-filter {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--primary-blue);
            color: var(--text-light);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 120px;
        }

        .search-input-container {
            position: relative;
            flex: 1;
        }

        .search-box input {
            width: 100%;
            padding: 0.6rem 2rem 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            background: var(--primary-dark);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        .search-box {
            position: relative;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-filter {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--primary-blue);
            color: var(--text-light);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 120px;
        }

        .search-input-container {
            position: relative;
            flex: 1;
        }

        .search-box input {
            width: 100%;
            padding: 0.6rem 2rem 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            background: var(--primary-dark);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
            outline: none;
        }

        .clear-search {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 0.25rem;
            line-height: 1;
            display: none;
        }

        .clear-search:hover {
            color: var(--text-light);
        }

        .search-results-count {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            margin-left: 0.5rem;
        }

        .clear-search {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 0.25rem;
            line-height: 1;
            display: none;
        }

        .clear-search:hover {
            color: var(--text-light);
        }

        .search-results-count {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            margin-left: 0.5rem;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }

        .filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
        }

        .term-switch {
            display: flex;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        .term-btn {
            background-color: var(--primary-dark);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            color: #555;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .term-btn.active {
            background-color: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }

        .term-btn:hover:not(.active) {
            background-color: #e0e0e0;
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 0.9rem;
            min-width: 150px;
        }

        /* Table Container */
        .table-container {
            flex: 1;
            background: var(--primary-blue);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background-color: var(--primary-dark);
            font-weight: 500;
            color: var(--accent-blue);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr {
            transition: background-color 0.2s ease;
        }
        
        tr:nth-child(even) {
            background-color: rgba(23, 42, 69, 0.5);
        }
        
        tr:hover {
            background-color: rgba(100, 255, 218, 0.05);
        }

        /* Action Buttons */
        .action-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin: 0 2px;
        }
        
        .action-btn:hover {
            background-color: rgba(100, 255, 218, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            text-decoration: none;
            transform: translateY(-1px);
        }
        
        .action-btn.delete {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        
        .action-btn.delete:hover {
            background-color: rgba(255, 107, 107, 0.1);
        }
        
        .action-btn.view-report-btn {
            color: #4a90e2;
            border-color: #4a90e2;
        }
        
        .action-btn.view-report-btn:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 25, 47, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
        }

        .modal-container {
            position: relative;
            background: white;
            margin: 40px auto;
            max-width: 600px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            background: none;
            border: none;
            transition: color 0.3s ease;
        }
        
        .close-btn:hover {
            color: var(--accent-blue);
        }

        .modal-body {
            padding: 24px;
        }

        /* Form Styles */
        .payment-form .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
            margin-bottom: 16px;
        }

        .payment-form .form-group {
            flex: 1 0 calc(50% - 20px);
            margin: 0 10px 16px;
            min-width: 200px;
        }

        .payment-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--accent-blue);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payment-form input,
        .payment-form select,
        .payment-form textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.95rem;
            background-color: var(--primary-dark);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .payment-form input:focus,
        .payment-form select:focus,
        .payment-form textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--accent-blue);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background-color: transparent;
            color: var(--accent-blue);
        }
        
        .btn:hover {
            background-color: rgba(100, 255, 218, 0.1);
        }
        
        .btn.primary {
            background-color: var(--accent-blue);
            color: var(--primary-dark);
            font-weight: 500;
        }
        
        .btn.primary:hover {
            background-color: rgba(100, 255, 218, 0.9);
        }

        /* Action Buttons Container */
        .actions-cell {
            white-space: nowrap;
            padding: 0.5rem !important;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 120px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 120px;
        }

        .action-btn {
            width: 100%;
            text-align: center;
            justify-content: center;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .action-btn i {
            font-size: 0.9em;
        }

        .edit-btn {
            background-color: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
            border-color: rgba(74, 144, 226, 0.3);
        }

        .edit-btn:hover {
            background-color: rgba(74, 144, 226, 0.2);
            transform: translateY(-1px);
        }

        .delete-btn {
            background-color: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
        }

        .delete-btn:hover {
            background-color: rgba(255, 107, 107, 0.2);
            transform: translateY(-1px);
        }

        .pay-btn {
            background-color: rgba(100, 255, 218, 0.1);
            color: #64ffda;
            border-color: rgba(100, 255, 218, 0.3);
        }

        .pay-btn:hover {
            background-color: rgba(100, 255, 218, 0.2);
            transform: translateY(-1px);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        /* Payment History Styles */
        .payment-history-cell {
            max-width: 300px;
            overflow: auto;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .payment-history-container {
            position: relative;
        }
        
        .view-all-payments {
            position: absolute;
            top: -35px;
            right: 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
        }
        
        .view-all-payments:hover {
            background-color: #45a049;
        }
        
        .payment-history {
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .payment-history li {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-history li:last-child {
            border-bottom: none;
        }

        .payment-amount {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .payment-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Statistics Cards */
        .statistics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--primary-blue);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .stat-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-light);
            margin: 0.5rem 0;
        }

        .stat-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border-radius: 2px;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.6s ease;
        }

        /* Card specific styles */
        .total-students .progress-bar {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }

        .total-fees .progress-bar {
            background: linear-gradient(90deg, #f6d365 0%, #fda085 100%);
        }

        .fees-paid .progress-bar {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .statistics-container {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .statistics-container {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 1rem;
            }
        }
        
        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a2e;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            max-width: 90%;
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #2a2a3a;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2a3a;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            color: #e6f1ff;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #8892b0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .modal-close:hover {
            color: #e6f1ff;
        }
        
        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #2a2a3a;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3e8e41;
        }
        
        .btn-secondary {
            background-color: #2a2a3a;
            color: #e6f1ff;
        }
        
        .btn-secondary:hover {
            background-color: #3a3a4a;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <header>
        <h1 class="header-title">Student Management</h1>
        <div class="header-actions">
            <button onclick="window.location.href='student-registration.html'" class="btn" style="background-color: #4CAF50; color: white;">
                <i>+</i> Add New Student
            </button>
        </div>
    </header>
    <main>
        <div class="statistics-container">
            <div class="stat-card total-students">
                <div class="stat-icon">ðŸ‘¥</div>
                <div class="stat-info">
                    <h3>Total Students</h3>
                    <div class="stat-value" id="totalStudents">0</div>
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat-card total-fees">
                <div class="stat-icon">ðŸ’°</div>
                <div class="stat-info">
                    <h3>Total Fee Balance</h3>
                    <div class="stat-value" id="totalFeeBalance">0 KES</div>
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: 60%"></div>
                </div>
            </div>
            <div class="stat-card fees-paid">
                <div class="stat-icon">ðŸ’µ</div>
                <div class="stat-info">
                    <h3>Total Fees Paid</h3>
                    <div class="stat-value" id="totalFeesPaid">0 KES</div>
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: 40%"></div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="toolbar">
                <div class="search-container">
                    <div class="search-box">
                        <select id="searchFilter" class="search-filter">
                            <option value="all">All Fields</option>
                            <option value="name">Name</option>
                            <option value="admission">Admission No</option>
                            <option value="class">Class</option>
                            <option value="parent">Parent Name</option>
                            <option value="phone">Phone</option>
                        </select>
                        <div class="search-input-container">
                            <input type="text" id="searchInput" placeholder="Search students..." autocomplete="off">
                            <button id="clearSearch" class="clear-search" title="Clear search">Ã—</button>
                        </div>
                        <div id="searchResultsCount" class="search-results-count"></div>
                    </div>
                </div>
                <div class="action-buttons" style="display: flex; gap: 10px;">
                    <button id="importBtn" class="btn" style="background-color: #4CAF50; color: white;">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                    <input type="file" id="fileInput" style="display: none;" accept=".xlsx, .xls">
                    <button id="exportBtn" class="btn" style="background-color: #2196F3; color: white;">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
                <div class="filters">
                    <div class="term-switch">
                        <button class="btn term-btn active" data-term="Term 1">Term 1</button>
                        <button class="btn term-btn" data-term="Term 2">Term 2</button>
                        <button class="btn term-btn" data-term="Term 3">Term 3</button>
                    </div>
                    <div class="filter-group">
                        <label for="classFilter">Class</label>
                        <select id="classFilter" class="filter-select" onchange="filterStudents()">
                            <option value="">All Classes</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                            <option value="4">Class 4</option>
                            <option value="5">Class 5</option>
                            <option value="6">Class 6</option>
                            <option value="7">Class 7</option>
                            <option value="8">Class 8</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="termFilter">Term</label>
                        <select id="termFilter" class="filter-select" onchange="filterStudents()">
                            <option value="">All Terms</option>
                            <option value="Term 1">Term 1</option>
                            <option value="Term 2">Term 2</option>
                            <option value="Term 3">Term 3</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">Status</label>
                        <select id="statusFilter" class="filter-select" onchange="filterStudents()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="flex: 1; overflow-y: auto;">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Student Name</th>
                            <th>Class</th>
                            <th>Class Teacher</th>
                            <th>Term Billing</th>
                            <th>Total Fee</th>
                            <th>Fee Balance</th>
                            <th>Transport Mode</th>
                            <th>Transport Location</th>
                            <th>Parent Name</th>
                            <th>Parent Phone</th>
                            <th>Actions</th>
                            <th>Payment History</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Student data will be populated by JavaScript -->
                        <tr>
                            <td colspan="8" class="no-data">Loading students data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="table-footer">
                <div class="pagination-info">
                    Showing <span id="startItem">1</span> to <span id="endItem">10</span> of <span id="totalItems">0</span> entries
                </div>
                <div class="pagination">
                    <button id="firstPage" disabled><i>Â«</i> First</button>
                    <button id="prevPage" disabled><i>â€¹</i> Previous</button>
                    <span style="display: flex; align-items: center; margin: 0 0.5rem;">Page <input type="number" id="pageInput" min="1" value="1" style="width: 50px; margin: 0 0.5rem; padding: 0.25rem;"> of <span id="totalPages" style="margin-left: 0.5rem;">1</span></span>
                    <button id="nextPage" disabled>Next <i>â€º</i></button>
                    <button id="lastPage" disabled>Last <i>Â»</i></button>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 School Management System</p>
    </footer>

    <!-- Local Storage Initialization -->
    <script>
        // Check if students data exists in localStorage, if not, initialize with empty array
        if (!localStorage.getItem('students')) {
            localStorage.setItem('students', JSON.stringify([]));
        }
        
        // Check if fee structure exists in localStorage, if not, initialize with default structure
        if (!localStorage.getItem('feeStructure')) {
            // This will be loaded from fee-structure.js
            console.log('Using default fee structure from fee-structure.js');
        }
        
        console.log('Local storage initialized successfully');
    </script>
    
    <!-- Payment Modal Popup -->
    <div id="payFeeModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2>Pay Fee</h2>
                <button class="close-modal" id="closePayFeeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="payFeeForm" class="payment-form">
                    <input type="hidden" id="payFeeAdmissionNumber">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method</label>
                            <select id="paymentMethod" class="form-control" required>
                                <option value="">-- Select Payment Method --</option>
                                <option value="Mpesa">Mpesa</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentTerm">Term</label>
                            <select id="paymentTerm" class="form-control" required>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amountPaid">Amount (Ksh)</label>
                            <input type="number" id="amountPaid" class="form-control" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionCode">Transaction Code</label>
                            <input type="text" id="transactionCode" class="form-control" placeholder="(if applicable)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receiptNumber">Receipt Number</label>
                            <input type="text" id="receiptNumber" class="form-control" placeholder="(optional)">
                        </div>
                        <div class="form-group" id="receiptDateDiv" style="display: none;">
                            <label for="receiptDate">Receipt Date</label>
                            <input type="date" id="receiptDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="paymentNotes">Notes</label>
                        <textarea id="paymentNotes" class="form-control" rows="3" placeholder="Add any notes about this payment"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" id="cancelPayment">Cancel</button>
                        <button type="submit" class="btn btn-submit">Submit Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Handle term switching
        document.addEventListener('DOMContentLoaded', function() {
            const termButtons = document.querySelectorAll('.term-btn');
            
            // Function to set active term and save to localStorage
            function setActiveTerm(term) {
                console.log('Setting active term to:', term);
                // Save to localStorage
                localStorage.setItem('selectedTerm', term);
                
                // Update UI
                const termButtons = document.querySelectorAll('.term-btn');
                termButtons.forEach(btn => {
                    if (btn.getAttribute('data-term') === term) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Update the term filter dropdown
                const termFilter = document.getElementById('termFilter');
                if (termFilter) {
                    termFilter.value = term;
                }
                
                // Apply filter
                filterByTerm(term);
            }
            
            // Function to handle term change with year-end check
            function handleTermChange(selectedTerm) {
                const previousTerm = localStorage.getItem('selectedTerm') || 'Term 1';
                console.log(`Term change: ${previousTerm} -> ${selectedTerm}`);
                
                // Check if we're moving to Term 1 from Term 3 (end of year)
                if (previousTerm === 'Term 3' && selectedTerm === 'Term 1') {
                    console.log('Showing year end reset modal');
                    // Show the year end reset modal
                    showYearEndResetModal();
                    // Revert the button states
                    setActiveTerm('Term 3');
                } else {
                    // Update the current term
                    setActiveTerm(selectedTerm);
                }
            }
            
            // Initialize term buttons and event listeners
            function initializeTermButtons() {
                const termButtons = document.querySelectorAll('.term-btn');
                termButtons.forEach(button => {
                    // Remove any existing click event listeners
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    // Add new click event listener
                    newButton.addEventListener('click', function() {
                        const selectedTerm = this.getAttribute('data-term');
                        console.log('Term button clicked:', selectedTerm);
                        handleTermChange(selectedTerm);
                    });
                });

                // Initialize with saved term or default to Term 1
                const savedTerm = localStorage.getItem('activeTerm') || 'Term 1';
                setActiveTerm(savedTerm);
            }
            
            // Initialize when DOM is loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    initializeFeeService().then(() => {
                        // Initialize with saved term
                        const savedTerm = localStorage.getItem('activeTerm') || 'Term 1';
                        setActiveTerm(savedTerm);
                        
                        // Initialize term buttons
                        initializeTermButtons();
                        
                        // Load students and display
                        displayStudents();
                    }).catch(error => {
                        console.error('Error initializing:', error);
                        // Fallback to localStorage
                        loadFeeStructure();
                        displayStudents();
                    });
                    initializeTermButtons();
                    setupActionButtons();
                });
            } else {
                initializeTermButtons();
                setupActionButtons();
            }
            
            // Function to set up action buttons
            function setupActionButtons() {
                const exportBtn = document.getElementById('exportBtn');
                const importBtn = document.getElementById('importBtn');
                const fileInput = document.getElementById('fileInput');
                
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportStudentsToExcel);
                }
                
                if (importBtn && fileInput) {
                    importBtn.addEventListener('click', () => fileInput.click());
                    
                    fileInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // Show loading modal
                        const modal = document.createElement('div');
                        modal.className = 'modal-overlay';
                        modal.innerHTML = `
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Importing Student Data</h3>
                                </div>
                                <div class="modal-body" style="text-align: center;">
                                    <div class="spinner"></div>
                                    <div style="margin-top: 15px;">Processing import. Please wait...</div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                        
                        try {
                            const result = await importStudentData(file);
                            
                            // Update modal with success message
                            modal.querySelector('.modal-body').innerHTML = `
                                <div style="text-align: center;">
                                    <div style="color: #4CAF50; font-size: 48px; margin: 10px 0 20px;">âœ“</div>
                                    <h3 style="margin-bottom: 15px; color: #4CAF50;">Import Completed Successfully!</h3>
                                    <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 6px; margin: 15px 0; text-align: left;">
                                        <div><strong>Total Processed:</strong> ${result.total} students</div>
                                        <div style="margin-top: 8px;"><strong>Added:</strong> ${result.added} new students</div>
                                        <div><strong>Updated:</strong> ${result.updated} existing students</div>
                                        ${result.skipped > 0 ? `<div><strong>Skipped:</strong> ${result.skipped} duplicates (already exist)</div>` : ''}
                                    </div>
                                    <p style="font-size: 0.9em; opacity: 0.8; margin: 15px 0 0;">
                                        The student list has been updated successfully.
                                    </p>
                                </div>
                            `;
                            
                            // Add close button to footer
                            const footer = document.createElement('div');
                            footer.className = 'modal-footer';
                            footer.innerHTML = `
                                <button id="closeImportModal" class="btn btn-primary">
                                    <i class="fas fa-check"></i> Done
                                </button>
                            `;
                            modal.querySelector('.modal-content').appendChild(footer);
                            
                            // Add event listener to close button
                            const closeBtn = modal.querySelector('#closeImportModal');
                            if (closeBtn) {
                                closeBtn.onclick = function() {
                                    document.body.removeChild(modal);
                                };
                            }
                            
                            // Refresh the student list
                            renderStudentList();
                            updateStatistics();
                            
                            // Auto-close after 8 seconds if not closed manually
                            setTimeout(() => {
                                if (document.body.contains(modal)) {
                                    document.body.removeChild(modal);
                                }
                            }, 8000);
                            
                        } catch (error) {
                            console.error('Error importing students:', error);
                            
                            // Update modal with error message
                            modal.querySelector('.modal-body').innerHTML = `
                                <div style="text-align: center;">
                                    <div style="color: #ff4444; font-size: 48px; margin: 10px 0 20px;">âœ—</div>
                                    <h3 style="margin-bottom: 15px; color: #ff4444;">Import Failed</h3>
                                    <div style="background: rgba(255, 68, 68, 0.1); padding: 15px; border-radius: 6px; margin: 15px 0; text-align: left; white-space: pre-wrap; word-wrap: break-word;">
                                        ${error.message || 'An unknown error occurred during import.'}
                                    </div>
                                    <p style="font-size: 0.9em; opacity: 0.8; margin: 15px 0 0;">
                                        Please check the file format and try again.
                                    </p>
                                </div>
                            `;
                            
                            // Add close button to footer
                            const footer = document.createElement('div');
                            footer.className = 'modal-footer';
                            footer.innerHTML = `
                                <button id="closeErrorModal" class="btn btn-danger">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            `;
                            modal.querySelector('.modal-content').appendChild(footer);
                            
                            // Add event listener to close button
                            const closeBtn = modal.querySelector('#closeErrorModal');
                            if (closeBtn) {
                                closeBtn.onclick = function() {
                                    document.body.removeChild(modal);
                                };
                            }
                            
                        } finally {
                            // Reset the file input
                            fileInput.value = '';
                            
                            // Don't remove the loading indicator here - we're showing a success/error message
                        }
                    });
                }
            }
            
            // Function to import students from Excel
            async function importStudentsFromExcel(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // Get the first worksheet
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            // Convert to JSON
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            if (jsonData.length === 0) {
                                throw new Error('The Excel file is empty');
                            }
                            
                            // Get existing students
                            const existingStudents = JSON.parse(localStorage.getItem('students')) || [];
                            const existingAdmissionNumbers = new Set(existingStudents.map(s => s.admissionNumber));
                            
                            // Process each row
                            const importedStudents = jsonData.map(row => {
                                // Extract class level from 'Class' column (e.g., 'Class 1' -> 1)
                                const classMatch = (row['Class'] || '').toString().match(/\d+/);
                                const classLevel = classMatch ? parseInt(classMatch[0]) : 1;
                                
                                // Create student object
                                const student = {
                                    admissionNumber: row['Admission Number']?.toString() || '',
                                    fullName: row['Name']?.toString() || '',
                                    classLevel: classLevel,
                                    stream: row['Stream']?.toString() || '',
                                    parentName: row['Parent Name']?.toString() || '',
                                    parentPhone: row['Parent Phone']?.toString() || '',
                                    status: (row['Status']?.toString() || 'active').toLowerCase(),
                                    registrationDate: row['Date Registered']?.toString() || new Date().toISOString().split('T')[0],
                                    payments: []
                                };
                                
                                // Add fee payments if they exist in the import
                                const terms = ['Term 1', 'Term 2', 'Term 3'];
                                terms.forEach(term => {
                                    const paid = parseFloat(row[`${term} Paid`]) || 0;
                                    if (paid > 0) {
                                        student.payments.push({
                                            term: term,
                                            amountPaid: paid,
                                            paymentMethod: 'Imported',
                                            datePaid: new Date().toLocaleDateString(),
                                            description: `Imported payment for ${term}`
                                        });
                                    }
                                });
                                
                                return student;
                            });
                            
                            // Filter out students that already exist (by admission number)
                            const newStudents = importedStudents.filter(student => 
                                student.admissionNumber && !existingAdmissionNumbers.has(student.admissionNumber)
                            );
                            
                            if (newStudents.length === 0) {
                                throw new Error('No new students to import (all admission numbers already exist)');
                            }
                            
                            // Combine with existing students
                            const updatedStudents = [...existingStudents, ...newStudents];
                            
                            // Save to localStorage
                            localStorage.setItem('students', JSON.stringify(updatedStudents));
                            
                            resolve({
                                total: importedStudents.length,
                                imported: newStudents.length,
                                skipped: importedStudents.length - newStudents.length
                            });
                            
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('Error reading the file'));
                    };
                    
                    // Read the file as array buffer
                    reader.readAsArrayBuffer(file);
                });
            }
            
            // Function to export students to Excel
            function exportStudentsToExcel() {
                const students = JSON.parse(localStorage.getItem('students')) || [];
                if (students.length === 0) {
                    alert('No student data to export');
                    return;
                }
                
                try {
                    // Prepare data for export
                    const data = students.map(student => {
                        // Calculate fees information
                        const terms = ['Term 1', 'Term 2', 'Term 3'];
                        const feeInfo = {};
                        
                        terms.forEach(term => {
                            const totalFee = calculateTotalFeeWithTerm(student, term);
                            const payments = (student.payments || []).filter(p => p.term === term);
                            const totalPaid = payments
                                .filter(p => !p.isCarryForward && !p.isDebtCarryForward)
                                .reduce((sum, p) => sum + (parseFloat(p.amountPaid) || 0), 0);
                            const balance = totalFee - totalPaid;
                            
                            feeInfo[`${term} Fee`] = totalFee;
                            feeInfo[`${term} Paid`] = totalPaid;
                            feeInfo[`${term} Balance`] = balance > 0 ? balance : 0;
                        });
                        
                        // Calculate overall totals
                        const totalFees = terms.reduce((sum, term) => sum + (feeInfo[`${term} Fee`] || 0), 0);
                        const totalPaid = terms.reduce((sum, term) => sum + (feeInfo[`${term} Paid`] || 0), 0);
                        const totalBalance = terms.reduce((sum, term) => sum + (feeInfo[`${term} Balance`] || 0), 0);
                        
                        return {
                            'Admission Number': student.admissionNumber || '',
                            'Name': student.fullName || '',
                            'Class': `Class ${student.classLevel || ''}`,
                            'Stream': student.stream || '',
                            'Parent Name': student.parentName || '',
                            'Parent Phone': student.parentPhone || '',
                            'Status': student.status || 'active',
                            'Term 1 Fee': feeInfo['Term 1 Fee'] || 0,
                            'Term 1 Paid': feeInfo['Term 1 Paid'] || 0,
                            'Term 1 Balance': feeInfo['Term 1 Balance'] || 0,
                            'Term 2 Fee': feeInfo['Term 2 Fee'] || 0,
                            'Term 2 Paid': feeInfo['Term 2 Paid'] || 0,
                            'Term 2 Balance': feeInfo['Term 2 Balance'] || 0,
                            'Term 3 Fee': feeInfo['Term 3 Fee'] || 0,
                            'Term 3 Paid': feeInfo['Term 3 Paid'] || 0,
                            'Term 3 Balance': feeInfo['Term 3 Balance'] || 0,
                            'Total Fees': totalFees,
                            'Total Paid': totalPaid,
                            'Total Balance': totalBalance,
                            'Date Registered': student.registrationDate || new Date().toISOString().split('T')[0]
                        };
                    });
                    
                    // Create workbook and worksheet
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Students');
                    
                    // Generate filename with current date
                    const dateStr = new Date().toISOString().slice(0, 10);
                    const filename = `Students_Export_${dateStr}.xlsx`;
                    
                    // Save the file
                    XLSX.writeFile(wb, filename);
                    
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    alert('An error occurred while exporting to Excel. Please check the console for details.');
                }
            }
        });

        function filterByTerm(term) {
            console.log('Filtering by term:', term);
            // Get all student rows
            const table = document.getElementById('studentsTable');
            if (!table) {
                console.error('Students table not found');
                return;
            }
            
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                console.error('Table body not found');
                return;
            }
            
            const rows = tbody.querySelectorAll('tr');
            console.log(`Found ${rows.length} rows to filter`);
            
            let visibleRows = 0;
            
            rows.forEach(row => {
                // If it's the loading row, skip it
                if (row.classList.contains('no-data')) return;
                
                // Get the term cell (assuming it's the 5th column - adjust if needed)
                const termCell = row.cells[4]; // 0-based index
                
                // If the row has a term that matches the selected term or 'All' is selected, show it
                if (term === 'All' || (termCell && termCell.textContent.trim() === term)) {
                    row.style.display = '';
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            console.log(`Filtered to show ${visibleRows} rows for term ${term}`);

            // Update the pagination if it exists
            if (window.updatePagination) {
                updatePagination();
            }
        }

        // Enhanced search functionality with debounce and better filtering
        let searchTimeout;
        
        // Initialize search functionality
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearch');
            const searchFilter = document.getElementById('searchFilter');
            
            if (!searchInput) return;
            
            // Toggle clear button visibility
            const toggleClearButton = () => {
                if (clearSearchBtn) {
                    clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
                }
            };
            
            // Add event listeners for search
            const performSearch = () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterStudents();
                    toggleClearButton();
                }, 300);
            };
            
            searchInput.addEventListener('input', performSearch);
            
            // Clear search
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    searchInput.focus();
                    filterStudents();
                    toggleClearButton();
                });
            }
            
            // Also trigger search when filter changes
            if (searchFilter) {
                searchFilter.addEventListener('change', () => {
                    if (searchInput.value) {
                        filterStudents();
                    }
                });
            }
            
            // Initial toggle
            toggleClearButton();
        }
        
        // Enhanced filter function with better search capabilities
        function filterStudents() {
            const classFilter = document.getElementById('classFilter')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value?.toLowerCase() || '';
            const searchQuery = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
            const searchFilter = document.getElementById('searchFilter')?.value || 'all';
            const activeTerm = document.querySelector('.term-btn.active')?.getAttribute('data-term') || 'All';
            
            // Get all student rows
            const rows = document.querySelectorAll('#studentsTable tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('no-data')) {
                    row.style.display = 'none';
                    return;
                }
                
                // Get all relevant cell data for searching
                const cells = Array.from(row.cells).map(cell => cell.textContent.trim().toLowerCase());
                const [admissionNo, studentName, studentClass, classTeacher, term, , , , parentName, phone, status] = cells;
                
                // Check filters
                const matchesClass = !classFilter || studentClass.includes(classFilter);
                const matchesStatus = !statusFilter || (status && status.toLowerCase().includes(statusFilter));
                const matchesTerm = activeTerm === 'All' || term === activeTerm.toLowerCase();
                
                // Check search query based on selected filter
                let matchesSearch = !searchQuery;
                if (searchQuery) {
                    const searchFields = {
                        'all': [studentName, admissionNo, studentClass, parentName, phone, classTeacher],
                        'name': [studentName],
                        'admission': [admissionNo],
                        'class': [studentClass],
                        'parent': [parentName],
                        'phone': [phone]
                    };
                    
                    const fieldsToSearch = searchFields[searchFilter] || searchFields['all'];
                    matchesSearch = fieldsToSearch.some(field => 
                        field && field.toLowerCase().includes(searchQuery)
                    );
                }
                
                // Show/hide row based on filters
                if (matchesClass && matchesStatus && matchesSearch && matchesTerm) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update search results count
            const resultsCount = document.getElementById('searchResultsCount');
            if (resultsCount) {
                resultsCount.textContent = searchQuery ? `${visibleCount} result${visibleCount !== 1 ? 's' : ''}` : '';
            }
            
            // Show message if no results found
            const noResultsRow = document.getElementById('noResults');
            if (visibleCount === 0) {
                if (!noResultsRow) {
                    const tbody = document.querySelector('#studentsTable tbody');
                    const row = document.createElement('tr');
                    row.id = 'noResults';
                    const cell = document.createElement('td');
                    cell.colSpan = document.querySelector('#studentsTable thead th')?.length || 10;
                    cell.textContent = 'No students found matching your search criteria';
                    cell.style.textAlign = 'center';
                    cell.style.padding = '20px';
                    row.appendChild(cell);
                    tbody.appendChild(row);
                } else {
                    noResultsRow.style.display = '';
                }
            } else if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
            
            // Update pagination if it exists
            if (window.updatePagination) {
                updatePagination();
            }
            
            // Update visible count
            const totalItems = document.getElementById('totalItems');
            if (totalItems) {
                totalItems.textContent = visibleCount;
            }
        }
        
        // Initialize search when document is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSearch);
        } else {
            initSearch();
        }
    </script>
    <!-- Year End Reset Modal -->
    <div id="yearEndModal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Year End Reset</h2>
                <button id="closeYearEndModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="yearEndContent">
                    <p>You have reached the last term of the year. Do you want to reset the system for the new academic year?</p>
                    <p><strong>Important:</strong> Before resetting, please export the student list and payment history for your records.</p>
                    <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button id="exportBeforeReset" class="btn" style="background-color: #4CAF50; color: white;">Export Data First</button>
                        <button id="confirmReset" class="btn" style="background-color: #f44336; color: white;">Reset Now</button>
                        <button id="cancelReset" class="btn">Cancel</button>
                    </div>
                </div>
                <div id="exportSection" style="display: none;">
                    <h3>Export Student Data</h3>
                    <p>Click the button below to download the complete student list with payment history as an Excel file.</p>
                    <button id="exportExcel" class="btn" style="background-color: #2196F3; color: white; margin: 10px 0;">
                        Export to Excel
                    </button>
                    <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button id="backToReset" class="btn">Back</button>
                        <button id="proceedAfterExport" class="btn" style="background-color: #f44336; color: white;">Reset System</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS library for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Load fee structure first -->
    <script src="fee-structure.js"></script>
    <!-- Then load student list which depends on fee structure -->
    <script src="student-list.js"></script>
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-cancel {
            background-color: #f0f0f0;
            color: #555;
        }

        .btn-cancel:hover {
            background-color: #e0e0e0;
        }

        .btn-submit {
            background-color: #4CAF50;
            color: white;
        }

        .btn-submit:hover {
            background-color: #45a049;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .payment-form .form-group {
                flex: 1 0 100%;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>

    <script>
        // Close modal variables
        const closeBtn = document.querySelector('.close-btn');
        const cancelBtn = document.querySelector('.cancel-btn');
        const modal = document.querySelector('.modal');
        const modalOverlay = document.querySelector('.modal-overlay');
        
        // Year End Reset Modal Functions
        function showYearEndResetModal() {
            const modal = document.getElementById('yearEndModal');
            if (modal) {
                document.getElementById('yearEndContent').style.display = 'block';
                document.getElementById('exportSection').style.display = 'none';
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeYearEndModal() {
            const modal = document.getElementById('yearEndModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function showExportSection() {
            document.getElementById('yearEndContent').style.display = 'none';
            document.getElementById('exportSection').style.display = 'block';
        }
        
        function showResetConfirmation() {
            document.getElementById('yearEndContent').style.display = 'block';
            document.getElementById('exportSection').style.display = 'none';
        }
        
        // Initialize Year End Reset Modal Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal when clicking the overlay
            const yearEndModal = document.getElementById('yearEndModal');
            if (yearEndModal) {
                yearEndModal.querySelector('.modal-overlay').addEventListener('click', closeYearEndModal);
                
                // Close button
                const closeBtn = yearEndModal.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeYearEndModal);
                }
                
                // Export Data First button
                const exportBtn = document.getElementById('exportBeforeReset');
                if (exportBtn) {
                    exportBtn.addEventListener('click', showExportSection);
                }
                
                // Back button
                const backBtn = document.getElementById('backToReset');
                if (backBtn) {
                    backBtn.addEventListener('click', showResetConfirmation);
                }
                
                // Reset Now button
                const resetNowBtn = document.getElementById('confirmReset');
                if (resetNowBtn) {
                    resetNowBtn.addEventListener('click', function() {
                        if (confirm('Are you sure you want to reset the system? This will clear all payment history and cannot be undone.')) {
                            resetSystemForNewYear();
                            closeYearEndModal();
                        }
                    });
                }
                
                // Export to Excel button
                const exportExcelBtn = document.getElementById('exportExcel');
                if (exportExcelBtn) {
                    exportExcelBtn.addEventListener('click', exportStudentData);
                }
                
                // Proceed After Export button
                const proceedAfterExportBtn = document.getElementById('proceedAfterExport');
                if (proceedAfterExportBtn) {
                    proceedAfterExportBtn.addEventListener('click', function() {
                        if (confirm('Have you exported all necessary data? This will clear all payment history and cannot be undone.')) {
                            resetSystemForNewYear();
                            closeYearEndModal();
                        }
                    });
                }
                
                // Cancel button
                const cancelBtn = document.getElementById('cancelReset');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeYearEndModal);
                }
            }
        });
        
        function exportStudentData() {
            try {
                // Get all students
                const students = getStudents();
                
                // Prepare data for export
                const exportData = students.map(student => {
                    return {
                        'Admission No.': student.admissionNumber,
                        'Full Name': student.fullName,
                        'Class': student.class,
                        'Total Fee': calculateTotalFeeWithTerm(student, 'Term 1'),
                        'Term 1 Paid': calculateTotalPayments(student, 'Term 1'),
                        'Term 1 Balance': calculateFeeBalance(student, 'Term 1'),
                        'Term 2 Paid': calculateTotalPayments(student, 'Term 2'),
                        'Term 2 Balance': calculateFeeBalance(student, 'Term 2'),
                        'Term 3 Paid': calculateTotalPayments(student, 'Term 3'),
                        'Term 3 Balance': calculateFeeBalance(student, 'Term 3'),
                        'Status': student.status || 'Active'
                    };
                });
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Student Data');
                
                // Generate file and download
                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `student_data_export_${date}.xlsx`);
                
                alert('Student data exported successfully!');
                
            } catch (error) {
                console.error('Error exporting student data:', error);
                alert('Failed to export student data. Please check the console for details.');
            }
        }
        
        function resetSystemForNewYear() {
            try {
                // Get all students
                const students = getStudents();
                
                // Reset payment history and balances for all students
                const updatedStudents = students.map(student => {
                    // Keep student data but clear payment history and reset balances
                    return {
                        ...student,
                        payments: [],
                        // Add any other fields that need to be reset
                    };
                });
                
                // Save updated students
                localStorage.setItem('students', JSON.stringify(updatedStudents));
                
                // Reset the active term to Term 1
                localStorage.setItem('selectedTerm', 'Term 1');
                
                // Update the UI
                const termButtons = document.querySelectorAll('.term-btn');
                termButtons.forEach(btn => {
                    if (btn.getAttribute('data-term') === 'Term 1') {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Refresh the student list
                filterByTerm('Term 1');
                
                alert('System has been reset for the new academic year. All payment history has been cleared.');
                
            } catch (error) {
                console.error('Error resetting system:', error);
                alert('Failed to reset system. Please check the console for details.');
            }
        }
        
        // Show payment modal
        function showPaymentModal(admissionNumber) {
            document.getElementById('payFeeAdmissionNumber').value = admissionNumber;
            document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
            modal.style.display = 'block';
        }
        
        // Close modal function
        function closeModal() {
            document.body.style.overflow = ''; // Re-enable scrolling
            modal.style.display = 'none';
        }
        
        // Event listeners
        closeBtn.addEventListener('click', closeModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
        
        // Close modal when clicking outside the modal content
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modal.style.display === 'block') {
                closeModal();
            }
        });
        
        // Form submission
        document.getElementById('payFeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = {
                admissionNumber: document.getElementById('payFeeAdmissionNumber').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                amount: document.getElementById('amountPaid').value,
                term: document.getElementById('paymentTerm').value,
                transactionCode: document.getElementById('transactionCode').value,
                receiptNumber: document.getElementById('receiptNumber').value
            };
            
            // Here you would typically send this data to your server
            console.log('Submitting payment:', formData);
            
            // Show success message
            alert('Payment submitted successfully!');
            
            // Close the modal
            closeModal();
            
            // Optional: Refresh the student list
            // loadStudents();
        });
        
        // Show/hide receipt date based on payment method
        document.getElementById('paymentMethod').addEventListener('change', function() {
            const receiptDateDiv = document.getElementById('receiptDateDiv');
            if (this.value === 'Cash' || this.value === 'Bank Transfer') {
                receiptDateDiv.style.display = 'block';
            } else {
                receiptDateDiv.style.display = 'none';
            }
        });
    </script>

    <!-- Add necessary script references -->
    <script src="js/fee-structure.js"></script>
    <script src="js/fee-balances.js"></script>
    <script src="js/student-list.js"></script>
</body>
</html>
